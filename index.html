<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kompetenz-Portfolio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for goal list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- --- Sidebar --- -->
        <aside class="w-72 bg-white p-4 border-r border-slate-200 flex flex-col shrink-0">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-indigo-100 rounded-lg">
                   <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2 0 0 1 0-5H20"></path></svg>
                </div>
                <h1 class="text-xl font-bold text-slate-900">Kompetenz-Portfolio</h1>
            </div>

            <!-- Overview Button -->
            <div class="mb-4">
                <button id="showOverviewBtn" class="w-full flex items-center gap-2 px-3 py-2 rounded-md transition-colors text-slate-700 hover:bg-slate-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8.3L12 15l-3.3-3.3c-.6-.6-1.4-.6-2-.1-.6.5-.7 1.4-.2 2L10 18l10-10"></path></svg>
                    <span class="font-semibold">Übersicht</span>
                </button>
            </div>

            <div class="flex justify-between items-center mb-3">
                <h2 class="font-semibold text-slate-500 text-sm uppercase tracking-wider">Fächer</h2>
                <button id="showAddSubjectBtn" class="p-1 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors" title="Neues Fach hinzufügen">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>

            <div id="addSubjectForm" class="hidden mb-4 p-3 bg-slate-50 rounded-lg transition-all">
                <input type="text" id="newSubjectName" placeholder="Name des Fachs..." class="w-full px-2 py-1.5 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                <div class="flex gap-2 mt-2">
                    <button id="addSubjectBtn" class="flex-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-md hover:bg-indigo-700 transition-colors">Hinzufügen</button>
                    <button id="cancelAddSubjectBtn" class="flex-1 px-3 py-1.5 bg-slate-200 text-slate-700 text-sm rounded-md hover:bg-slate-300 transition-colors">Abbrechen</button>
                </div>
            </div>

            <nav id="subject-nav" class="space-y-1 overflow-y-auto"></nav>
        </aside>

        <!-- --- Main Content --- -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    const STORAGE_KEY = 'kompetenzPortfolioApp';
    let appState = {
        data: {},
        activeSubject: null // null for overview, subject name for subject view
    };

    // Defines information for each status category, including Tailwind colors and Chart.js colors
    const statusInfo = {
        erreicht: { label: 'Erreicht', color: 'bg-emerald-500', chartBg: 'rgba(52, 211, 153, 0.4)', chartBorder: 'rgba(16, 185, 129, 1)', chartBubble: 'rgba(52, 211, 153, 0.7)', pieColor: '#34d399' }, // emerald-500
        teilweise: { label: 'Teilweise', color: 'bg-amber-500', chartBg: 'rgba(251, 191, 36, 0.4)', chartBorder: 'rgba(245, 158, 11, 1)', chartBubble: 'rgba(251, 191, 36, 0.7)', pieColor: '#f59e0b' }, // amber-500
        nicht: { label: 'Nicht erreicht', color: 'bg-red-500', chartBg: 'rgba(248, 113, 113, 0.4)', chartBorder: 'rgba(239, 68, 68, 1)', chartBubble: 'rgba(248, 113, 113, 0.7)', pieColor: '#ef4444' } // red-500
    };

    // Holds Chart.js instances to allow for their destruction before re-rendering
    let charts = {
        timelineGrund: null,
        timelineErweitert: null,
        bubbleChart: null,
        pieChartGrund: null, // Neuer Chart-Instanz-Key
        pieChartErweitert: null, // Neuer Chart-Instanz-Key
    };

    // --- DOM SELECTORS ---
    const mainContent = document.getElementById('main-content');
    const subjectNav = document.getElementById('subject-nav');
    const showAddSubjectBtn = document.getElementById('showAddSubjectBtn');
    const addSubjectForm = document.getElementById('addSubjectForm');
    const newSubjectNameInput = document.getElementById('newSubjectName');
    const addSubjectBtn = document.getElementById('addSubjectBtn');
    const cancelAddSubjectBtn = document.getElementById('cancelAddSubjectBtn');
    const showOverviewBtn = document.getElementById('showOverviewBtn');

    // --- DATA & STATE FUNCTIONS ---
    // Loads the application state from localStorage or initializes with sample data
    function loadState() {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            appState = JSON.parse(savedState);
        } else {
            // Default sample data for demonstration
            appState.data = {
                'Mathematik': [
                    { id: 1622548800000, text: 'Bruchrechnung verstehen', category: 'grund', weight: 3, status: 'erreicht', date: '2025-05-15' },
                    { id: 1625140800001, text: 'Gleichungen lösen', category: 'grund', weight: 4, status: 'teilweise', date: '2025-06-20' },
                    { id: 1627732800002, text: 'Komplexe Textaufgaben', category: 'erweitert', weight: 5, status: 'nicht', date: '2025-07-05' },
                    { id: 1627732800003, text: 'Logarithmen', category: 'erweitert', weight: 3, status: 'teilweise', date: '2025-07-10' },
                    { id: 1627732800004, text: 'Geometrie Grundlagen', category: 'grund', weight: 2, status: 'erreicht', date: '2025-06-01' }
                ],
                'Deutsch': [
                    { id: 1622548800005, text: 'Rechtschreibung', category: 'grund', weight: 4, status: 'erreicht', date: '2025-04-10' },
                    { id: 1622548800006, text: 'Grammatik Anwendung', category: 'grund', weight: 3, status: 'teilweise', date: '2025-05-20' },
                    { id: 1622548800007, text: 'Aufsatz schreiben', category: 'erweitert', weight: 5, status: 'nicht', date: '2025-06-15' }
                ],
                'Englisch': [
                    { id: 1622548800008, text: 'Vokabeln A1', category: 'grund', weight: 3, status: 'erreicht', date: '2025-03-01' },
                    { id: 1622548800009, text: 'Konversation', category: 'erweitert', weight: 4, status: 'teilweise', date: '2025-04-05' }
                ]
            };
            appState.activeSubject = null; // Start on overview page
        }
        // Ensure active subject is set to null if it somehow points to a non-existent subject
        if (Object.keys(appState.data).length > 0 && appState.activeSubject !== null && !appState.data[appState.activeSubject]) {
            appState.activeSubject = null;
        }
    }

    // Saves the current application state to localStorage
    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    }

    // Adds a new subject to the appState
    function addSubject() {
        const name = newSubjectNameInput.value.trim();
        if (name && !appState.data[name]) { // Check if name is not empty and not already exists
            appState.data[name] = [];
            appState.activeSubject = name; // Set new subject as active
            saveState();
            render();
            newSubjectNameInput.value = ''; // Clear input
            addSubjectForm.classList.add('hidden'); // Hide form
        }
    }
    
    // --- MODAL DIALOG for confirmations ---
    // Displays a custom confirmation modal instead of native alert/confirm
    function showConfirmationModal(message, onConfirm) {
        // Remove existing modal first to prevent duplicates
        const existingModal = document.getElementById('confirmationModal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
            <div id="confirmationModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <p class="text-slate-800 mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="modalCancelBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition">Abbrechen</button>
                        <button id="modalConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Löschen</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modal = document.getElementById('confirmationModal');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        confirmBtn.onclick = () => {
            onConfirm();
            modal.remove();
        };
        cancelBtn.onclick = () => {
            modal.remove();
        };
    }

    // Removes a subject after user confirmation
    function removeSubject(subjectName) {
        const message = `Sind Sie sicher, dass Sie das Fach "${subjectName}" und alle zugehörigen Lernziele löschen möchten?`;
        showConfirmationModal(message, () => {
            delete appState.data[subjectName];
            if (appState.activeSubject === subjectName) {
                // After deleting, set active subject to the first available or null (overview)
                appState.activeSubject = Object.keys(appState.data)[0] || null; 
            }
            saveState();
            render();
        });
    }

    // Adds a new learning goal to the active subject
    function addGoal(goal) {
        if (!appState.activeSubject) return; // Cannot add goal if no subject is active
        appState.data[appState.activeSubject].push({ ...goal, id: Date.now() });
        saveState();
        render();
    }

    // Removes a learning goal from the active subject
    function removeGoal(goalId) {
        if (!appState.activeSubject) return;
        const goals = appState.data[appState.activeSubject];
        appState.data[appState.activeSubject] = goals.filter(g => g.id !== goalId);
        saveState();
        render();
    }
    
    // --- RENDERING FUNCTIONS ---

    // Renders the sidebar with subject navigation and add subject form
    function renderSidebar() {
        subjectNav.innerHTML = ''; // Clear existing subjects
        Object.keys(appState.data).forEach(name => {
            const isActive = name === appState.activeSubject;
            const container = document.createElement('div');
            container.className = 'flex items-center group';

            const button = document.createElement('button');
            button.className = `flex-1 text-left px-3 py-2 rounded-md transition-colors text-slate-700 ${isActive ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-slate-100'}`;
            button.textContent = name;
            button.onclick = () => {
                appState.activeSubject = name;
                saveState();
                render();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-100 rounded-md transition-all opacity-0 group-hover:opacity-100';
            deleteBtn.title = `Fach "${name}" löschen`;
            // SVG for delete icon
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent subject selection when deleting
                removeSubject(name);
            };

            container.appendChild(button);
            container.appendChild(deleteBtn);
            subjectNav.appendChild(container);
        });

        // Update overview button style based on activeSubject state
        if (appState.activeSubject === null) {
            showOverviewBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        } else {
            showOverviewBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        }
    }

    // Renders the main content area, either the subject-specific view or the overview
    function renderMainContent() {
        if (appState.activeSubject === null) {
            renderOverviewPage();
            return;
        }

        // Subject-specific view HTML structure
        mainContent.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
                <!-- Left Column (Form & List) -->
                <div class="xl:col-span-2 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-4 text-slate-800">Neues Lernziel für ${appState.activeSubject}</h2>
                        <form id="goalForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Text</label>
                                <input type="text" name="text" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Kategorie</label>
                                    <select name="category" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                        <option value="grund">Grundanforderung</option>
                                        <option value="erweitert">Erweiterte Anforderung</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Beurteilung</label>
                                    <select name="status" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                        <option value="erreicht">Erreicht</option>
                                        <option value="teilweise">Teilweise</option>
                                        <option value="nicht">Nicht erreicht</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Gewichtung (1-5)</label>
                                <input type="range" name="weight" min="1" max="5" value="3" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Datum</label>
                                <input type="date" name="date" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition">Hinzufügen</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-4 text-slate-800">Lernziele-Liste</h2>
                        <div id="goalList" class="space-y-3 max-h-[45vh] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Goal items will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column (Charts) -->
                <div class="xl:col-span-3 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Lernstand Übersicht nach Gewichtung</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-slate-700">Grundanforderungen</h4>
                                <div class="h-64 mx-auto">
                                    <canvas id="pieChartGrund"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-slate-700">Erweiterte Anforderungen</h4>
                                <div class="h-64 mx-auto">
                                    <canvas id="pieChartErweitert"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Entwicklung Grundanforderungen</h3>
                                <canvas id="timelineGrund"></canvas>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Entwicklung Erweiterte Anforderungen</h3>
                                <canvas id="timelineErweitert"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Bubble-Übersicht</h3>
                        <div class="h-80 mx-auto">
                           <canvas id="bubbleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const goalForm = document.getElementById('goalForm');
        // Set default date to today
        goalForm.querySelector('input[name="date"]').valueAsDate = new Date(); 
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newGoal = {
                text: formData.get('text'),
                category: formData.get('category'),
                status: formData.get('status'),
                weight: +formData.get('weight'), // Convert to number
                date: formData.get('date'),
            };
            addGoal(newGoal);
            e.target.reset(); // Clear form
            goalForm.querySelector('input[name="date"]').valueAsDate = new Date(); // Reset date
        });

        renderGoalList();
        renderCharts();
    }
    
    // Renders the list of learning goals for the active subject
    function renderGoalList() {
        const goalListContainer = document.getElementById('goalList');
        if (!goalListContainer) return;
        const goals = appState.data[appState.activeSubject] || [];

        goalListContainer.innerHTML = '';
        if (goals.length === 0) {
            goalListContainer.innerHTML = `<p class="text-slate-500 text-center py-4">Noch keine Lernziele erfasst.</p>`;
            return;
        }

        // Sort goals by date in descending order
        goals.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(goal => {
            const el = document.createElement('div');
            el.className = 'p-3.5 border border-slate-200 rounded-lg bg-slate-50';
            const statusColor = statusInfo[goal.status]?.color || 'bg-slate-400';
            const categoryText = goal.category === 'grund' ? 'Grundanforderung' : 'Erweiterte Anforderung';
            const formattedDate = new Date(goal.date).toLocaleDateString('de-DE');

            el.innerHTML = `
                <div class="flex justify-between items-start gap-3">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">${goal.text}</p>
                        <div class="flex items-center gap-4 text-sm text-slate-500 mt-2 flex-wrap">
                            <span class="flex items-center gap-1.5 whitespace-nowrap"><span class="w-3 h-3 rounded-full ${statusColor}"></span>${statusInfo[goal.status]?.label}</span>
                            <span>${categoryText}</span>
                            <span>Gewicht: ${goal.weight}</span>
                            <span>${formattedDate}</span>
                        </div>
                    </div>
                    <button class="delete-goal-btn flex-shrink-0 text-slate-400 hover:text-red-600 transition-colors" title="Löschen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                    </button>
                </div>
            `;
            el.querySelector('.delete-goal-btn').addEventListener('click', () => removeGoal(goal.id));
            goalListContainer.appendChild(el);
        });
    }

    // Renders all Chart.js graphs for the active subject
    function renderCharts() {
        const goals = appState.data[appState.activeSubject] || [];
        const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

        // Destroy existing charts to prevent memory leaks and rendering issues
        for (const chartKey in charts) {
            if (charts[chartKey]) {
                charts[chartKey].destroy();
                charts[chartKey] = null;
            }
        }

        // --- Pie Charts (one for Grundanforderungen, one for Erweiterte Anforderungen) ---
        ['grund', 'erweitert'].forEach(type => {
            const canvasId = type === 'grund' ? 'pieChartGrund' : 'pieChartErweitert';
            const chartInstanceKey = type === 'grund' ? 'pieChartGrund' : 'pieChartErweitert';
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;

            const filteredGoals = goals.filter(g => g.category === type);
            const statusWeightedSums = { erreicht: 0, teilweise: 0, nicht: 0 };

            // Calculate weighted sums for each status
            filteredGoals.forEach(goal => {
                if (statusWeightedSums[goal.status] !== undefined) {
                    statusWeightedSums[goal.status] += goal.weight;
                }
            });

            const pieData = {
                labels: Object.values(statusInfo).map(s => s.label),
                datasets: [{
                    // Use weighted sums for the data
                    data: Object.keys(statusInfo).map(status => statusWeightedSums[status]),
                    backgroundColor: Object.values(statusInfo).map(s => s.pieColor),
                    hoverOffset: 4
                }]
            };

            const pieConfig = {
                type: 'pie',
                data: pieData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    // Display weighted points and percentage
                                    return `${label}: ${value.toFixed(1)} gew. Pkt. (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };
            charts[chartInstanceKey] = new Chart(ctx, pieConfig);
        });

        // Timeline charts with percentages
        ['grund', 'erweitert'].forEach(type => {
            const canvasId = type === 'grund' ? 'timelineGrund' : 'timelineErweitert';
            const chartInstanceKey = type === 'grund' ? 'timelineGrund' : 'timelineErweitert';
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;

            // Hier werden die gewichteten Summen für die Zeitachsen-Diagramme berechnet
            // based on `weight` property.
            const monthlyWeightedSums = months.map(() => ({ erreicht: 0, teilweise: 0, nicht: 0 }));
            goals.filter(g => g.category === type).forEach(g => {
                const monthIndex = new Date(g.date).getMonth();
                if(monthlyWeightedSums[monthIndex]) { 
                    monthlyWeightedSums[monthIndex][g.status] += g.weight;
                }
            });
            
            const monthlyPercentages = monthlyWeightedSums.map(monthData => {
                const totalWeight = monthData.erreicht + monthData.teilweise + monthData.nicht;
                if (totalWeight === 0) {
                    return { erreicht: 0, teilweise: 0, nicht: 0 };
                }
                return {
                    erreicht: (monthData.erreicht / totalWeight) * 100,
                    teilweise: (monthData.teilweise / totalWeight) * 100,
                    nicht: (monthData.nicht / totalWeight) * 100
                };
            });

            const datasets = Object.keys(statusInfo).map(status => ({
                label: statusInfo[status].label,
                data: monthlyPercentages.map(m => m[status]),
                fill: true,
                backgroundColor: statusInfo[status].chartBg,
                borderColor: statusInfo[status].chartBorder,
                tension: 0.3,
            }));

            const config = {
                type: 'line',
                data: { labels: months, datasets },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: { 
                        x: { stacked: true }, 
                        y: { 
                            stacked: true, 
                            min: 0, max: 100,
                            title: { display: true, text: 'Prozentualer Anteil (gewichtet)' },
                            ticks: { callback: value => value + '%' }
                        } 
                    },
                    plugins: { 
                        legend: { position: 'bottom' }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
                            } 
                        } 
                    },
                    interaction: { mode: 'index', intersect: false },
                }
            };
            charts[chartInstanceKey] = new Chart(ctx, config);
        });

        // --- Bubble chart with 'rect' for extended requirements ---
        const ctxB = document.getElementById('bubbleChart')?.getContext('2d');
        if (!ctxB) return;
        
        const bubbleDatasets = [];
        // Define shapes for different categories (circle for grund, rect for erweitert)
        const bubbleTypes = [{key:'grund', shape:'circle', labelCategory: 'Grundanforderungen'}, {key:'erweitert', shape:'rect', labelCategory: 'Erweiterte Anforderungen'}];

        bubbleTypes.forEach((t, iType) => {
            Object.keys(statusInfo).forEach((status, iStatus) => {
                const filteredGoals = goals.filter(g=>g.category===t.key && g.status===status);
                const sumWeight = filteredGoals.reduce((sum,g)=>sum+g.weight,0);
                const goalCount = filteredGoals.length; // Get the actual count of goals
                if (goalCount > 0) { // Only add a bubble if there are goals
                    bubbleDatasets.push({
                        label: `${t.labelCategory}: ${statusInfo[status].label}`,
                        data:[{ 
                            x: iType + Math.random() * 0.4 - 0.2, // Randomize X slightly to prevent overlap
                            y: iStatus + Math.random() * 0.4 - 0.2, // Randomize Y slightly
                            r: Math.sqrt(sumWeight) * 8 + 4, // Radius based on weighted sum
                            goalCount: goalCount // Store the count for tooltip
                        }],
                        backgroundColor: statusInfo[status].chartBubble,
                        pointStyle: t.shape // Set the point style (circle/rect)
                    });
                }
            });
        });

        const configB = {
            type: 'bubble',
            data: { datasets: bubbleDatasets },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    x: { display: false, min: -0.5, max: 2.5 }, 
                    y: { display: false, min: -0.5, max: 3.5 } 
                },
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            usePointStyle: true, // Make the legend use the point styles (circle/rect)
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                // Access the custom 'goalCount' from the raw data
                                const dataPoint = context.raw;
                                return `${context.dataset.label}: ${dataPoint.goalCount} Lernziele`;
                            }
                        }
                    }
                }
            }
        };
        charts.bubbleChart = new Chart(ctxB, configB);
    }
    
    // Renders the overview page displaying a summary of each subject's progress
    function renderOverviewPage() {
        mainContent.innerHTML = `
            <div class="p-8 bg-white rounded-xl shadow-sm">
                <h2 class="text-3xl font-bold mb-6 text-slate-800">Übersicht Lernstand</h2>
                <div id="subjectOverviewGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Subject overview cards will be injected here -->
                </div>
            </div>
        `;

        const overviewGrid = document.getElementById('subjectOverviewGrid');
        if (!overviewGrid) return;

        if (Object.keys(appState.data).length === 0) {
            overviewGrid.innerHTML = `<p class="text-slate-500 text-center col-span-full py-10">Fügen Sie Fächer hinzu, um eine Übersicht zu erhalten.</p>`;
            return;
        }

        Object.keys(appState.data).forEach(subjectName => {
            const goals = appState.data[subjectName];

            // --- HIER WERDEN DIE GEWICHTETEN PUNKTEN FÜR GRUNDANFORDERUNGEN BERECHNET ---
            const grundGoals = goals.filter(g => g.category === 'grund');
            const totalWeightedGrund = grundGoals.reduce((sum, g) => sum + g.weight, 0);
            const achievedWeightedGrund = grundGoals.filter(g => g.status === 'erreicht').reduce((sum, g) => sum + g.weight, 0);
            const percentageGrund = totalWeightedGrund > 0 ? ((achievedWeightedGrund / totalWeightedGrund) * 100).toFixed(0) : 0;

            // --- HIER WERDEN DIE GEWICHTETEN PUNKTEN FÜR ERWEITERTE ANFORDERUNGEN BERECHNET ---
            const erweitertGoals = goals.filter(g => g.category === 'erweitert');
            const totalWeightedErweitert = erweitertGoals.reduce((sum, g) => sum + g.weight, 0);
            const achievedWeightedErweitert = erweitertGoals.filter(g => g.status === 'erreicht').reduce((sum, g) => sum + g.weight, 0);
            const percentageErweitert = totalWeightedErweitert > 0 ? ((achievedWeightedErweitert / totalWeightedErweitert) * 100).toFixed(0) : 0;
            
            // Determine progress bar colors
            const progressColorGrund = percentageGrund >= 75 ? 'bg-emerald-500' : (percentageGrund >= 40 ? 'bg-amber-500' : 'bg-red-500');
            const progressColorErweitert = percentageErweitert >= 75 ? 'bg-emerald-500' : (percentageErweitert >= 40 ? 'bg-amber-500' : 'bg-red-500');

            const card = document.createElement('div');
            card.className = `bg-slate-50 p-6 rounded-lg shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-shadow`;
            card.onclick = () => {
                appState.activeSubject = subjectName; // Switch to this subject's detail view
                saveState();
                render();
            };
            card.innerHTML = `
                <h3 class="text-xl font-bold text-slate-800 mb-3">${subjectName}</h3>
                
                <div class="mb-3">
                    <p class="text-sm text-slate-600 mb-1">Grundanforderungen:</p>
                    <div class="flex items-center gap-3">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full ${progressColorGrund}" style="width: ${percentageGrund}%"></div>
                        </div>
                        <span class="text-slate-600 font-semibold text-sm">${percentageGrund}%</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">${achievedWeightedGrund.toFixed(1)} von ${totalWeightedGrund.toFixed(1)} gewichteten Punkten</p>
                </div>

                <div>
                    <p class="text-sm text-slate-600 mb-1">Erweiterte Anforderungen:</p>
                    <div class="flex items-center gap-3">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full ${progressColorErweitert}" style="width: ${percentageErweitert}%"></div>
                        </div>
                        <span class="text-slate-600 font-semibold text-sm">${percentageErweitert}%</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">${achievedWeightedErweitert.toFixed(1)} von ${totalWeightedErweitert.toFixed(1)} gewichteten Punkten</p>
                </div>
            `;
            overviewGrid.appendChild(card);
        });
    }

    // --- MASTER RENDER & EVENT LISTENERS ---
    // Main render function that orchestrates UI updates
    function render() {
        renderSidebar();
        renderMainContent();
    }

    // Event listener for showing the add subject form
    showAddSubjectBtn.addEventListener('click', () => {
        addSubjectForm.classList.remove('hidden');
        newSubjectNameInput.focus();
    });
    // Event listener for canceling add subject
    cancelAddSubjectBtn.addEventListener('click', () => {
        addSubjectForm.classList.add('hidden');
        newSubjectNameInput.value = '';
    });
    // Event listener for adding a subject
    addSubjectBtn.addEventListener('click', addSubject);
    // Event listener for adding a subject with Enter key
    newSubjectNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addSubject();
    });
    // Event listener for the "Übersicht" button
    showOverviewBtn.addEventListener('click', () => {
        appState.activeSubject = null; // Set active subject to null to show overview
        saveState();
        render();
    });

    // --- INITIALIZATION ---
    loadState(); // Load saved data
    render(); // Initial render of the UI
});
</script>

</body>
</html>
