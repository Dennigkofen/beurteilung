<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kompetenz-Portfolio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for goal list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- --- Sidebar --- -->
        <aside class="w-72 bg-white p-4 border-r border-slate-200 flex flex-col shrink-0">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-indigo-100 rounded-lg">
                   <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2 0 0 1 0-5H20"></path></svg>
                </div>
                <h1 class="text-xl font-bold text-slate-900">Kompetenz-Portfolio</h1>
            </div>

            <!-- Student Management -->
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-semibold text-slate-500 text-sm uppercase tracking-wider">Schüler</h2>
                <button id="showAddStudentBtn" class="p-1 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors" title="Neuen Schüler hinzufügen">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
            <div id="addStudentForm" class="hidden mb-4 p-3 bg-slate-50 rounded-lg transition-all">
                <input type="text" id="newStudentName" placeholder="Name des Schülers..." class="w-full px-2 py-1.5 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                <div class="flex gap-2 mt-2">
                    <button id="addStudentBtn" class="flex-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-md hover:bg-indigo-700 transition-colors">Hinzufügen</button>
                    <button id="cancelAddStudentBtn" class="flex-1 px-3 py-1.5 bg-slate-200 text-slate-700 text-sm rounded-md hover:bg-slate-300 transition-colors">Abbrechen</button>
                </div>
            </div>
            <nav id="student-nav" class="space-y-1 overflow-y-auto mb-6 custom-scrollbar"></nav>


            <!-- Overview Button (now specific to active student) -->
            <div class="mb-4">
                <button id="showOverviewBtn" class="w-full flex items-center gap-2 px-3 py-2 rounded-md transition-colors text-slate-700 hover:bg-slate-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8.3L12 15l-3.3-3.3c-.6-.6-1.4-.6-2-.1-.6.5-.7 1.4-.2 2L10 18l10-10"></path></svg>
                    <span class="font-semibold">Übersicht (Aktueller Schüler)</span>
                </button>
            </div>

            <div class="flex justify-between items-center mb-3">
                <h2 class="font-semibold text-slate-500 text-sm uppercase tracking-wider">Fächer (Aktueller Schüler)</h2>
                <!-- Add Subject Button is now part of the main content when a student is selected -->
            </div>

            <nav id="subject-nav" class="space-y-1 overflow-y-auto custom-scrollbar"></nav>
        </aside>

        <!-- --- Main Content --- -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    const STORAGE_KEY = 'kompetenzPortfolioApp';
    let appState = {
        students: {}, // studentId: { name: 'Student Name', subjects: { 'FachName': [goals] } }
        activeStudent: null, // ID of the currently selected student
        activeSubject: null, // null for overview, subject name for subject view
        masterSubjects: {} // Global template for goals, copied to new students
    };

    // Defines information for each status category, including Tailwind colors and Chart.js colors
    const statusInfo = {
        erreicht: {
            label: 'Erreicht',
            color: 'bg-emerald-500', // Tailwind class for status indicator
            chartBg: 'rgba(52, 211, 153, 0.4)', // Chart.js background for line charts (lighter opacity)
            chartBgOpaque: 'rgba(52, 211, 153, 1.0)', // Chart.js background for 100% opaque bubbles
            chartBgTransparent: 'rgba(52, 211, 153, 0.1)', // Chart.js background for 10% opaque bubbles
            chartBorder: 'rgba(16, 185, 129, 1)', // Chart.js border for line charts
            pieColorOpaque: '#34d399', // 100% opacity for pie charts
            pieColorTransparent: 'rgba(52, 211, 153, 0.1)', // 10% opacity for pie charts
            bubbleBorderColor: 'rgba(16, 185, 129, 1)' // Consistent border color for bubbles
        },
        teilweise: {
            label: 'Teilweise',
            color: 'bg-amber-500',
            chartBg: 'rgba(251, 191, 36, 0.4)',
            chartBgOpaque: 'rgba(251, 191, 36, 1.0)',
            chartBgTransparent: 'rgba(251, 191, 36, 0.1)',
            chartBorder: 'rgba(245, 158, 11, 1)',
            pieColorOpaque: '#f59e0b',
            pieColorTransparent: 'rgba(251, 191, 36, 0.1)',
            bubbleBorderColor: 'rgba(245, 158, 11, 1)'
        },
        nicht: {
            label: 'Nicht erreicht',
            color: 'bg-red-500',
            chartBg: 'rgba(248, 113, 113, 0.4)',
            chartBgOpaque: 'rgba(248, 113, 113, 1.0)',
            chartBgTransparent: 'rgba(248, 113, 113, 0.1)',
            chartBorder: 'rgba(239, 68, 68, 1)',
            pieColorOpaque: '#ef4444',
            pieColorTransparent: 'rgba(248, 113, 113, 0.1)',
            bubbleBorderColor: 'rgba(239, 68, 68, 1)'
        }
    };

    // Holds Chart.js instances to allow for their destruction before re-rendering
    let charts = {
        timelineGrund: null,
        timelineErweitert: null,
        bubbleChart: null,
        weightedPieChartGrundInitial: null, // New chart key
        weightedPieChartGrundCorrected: null, // New chart key
        weightedPieChartErweitertInitial: null, // New chart key
        weightedPieChartErweitertCorrected: null, // New chart key
    };

    // --- DOM SELECTORS ---
    const mainContent = document.getElementById('main-content');
    const subjectNav = document.getElementById('subject-nav');
    const studentNav = document.getElementById('student-nav'); // New
    const showAddSubjectBtn = document.getElementById('showAddSubjectBtn'); // This will be repurposed
    const addSubjectForm = document.getElementById('addSubjectForm'); // This will be repurposed
    const newSubjectNameInput = document.getElementById('newSubjectName'); // This will be repurposed
    const addSubjectBtn = document.getElementById('addSubjectBtn'); // This will be repurposed
    const cancelAddSubjectBtn = document.getElementById('cancelAddSubjectBtn'); // This will be repurposed
    const showOverviewBtn = document.getElementById('showOverviewBtn');

    // New student management selectors
    const showAddStudentBtn = document.getElementById('showAddStudentBtn');
    const addStudentForm = document.getElementById('addStudentForm');
    const newStudentNameInput = document.getElementById('newStudentName');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const cancelAddStudentBtn = document.getElementById('cancelAddStudentBtn');

    // --- DATA & STATE FUNCTIONS ---
    // Loads the application state from localStorage or initializes with sample data
    function loadState() {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            appState = JSON.parse(savedState);
            // Ensure masterSubjects are present in loaded state or initialize them
            if (!appState.masterSubjects || Object.keys(appState.masterSubjects).length === 0) {
                 initializeMasterSubjects();
            }
        } else {
            // Default sample data for demonstration
            initializeMasterSubjects(); // Setup master goals first
            
            // Add a default student and clone master goals for them
            const defaultStudentId = 'student_default';
            appState.students[defaultStudentId] = {
                id: defaultStudentId,
                name: 'Max Mustermann',
                subjects: cloneMasterGoalsForNewStudent()
            };
            appState.activeStudent = defaultStudentId;
            appState.activeSubject = null; // Start on overview page for the default student
        }
        // Ensure active student is set if none is, or if it points to a non-existent one
        if (!appState.activeStudent || !appState.students[appState.activeStudent]) {
            appState.activeStudent = Object.keys(appState.students)[0] || null;
        }
        // If active subject points to non-existent subject, set to null
        if (appState.activeStudent && appState.activeSubject !== null && !appState.students[appState.activeStudent].subjects[appState.activeSubject]) {
            appState.activeSubject = null;
        }
    }

    // Initializes master subjects with sample data
    function initializeMasterSubjects() {
        appState.masterSubjects = {
            'Mathematik': [
                { text: 'Bruchrechnung verstehen', category: 'grund', weight: 3 },
                { text: 'Gleichungen lösen', category: 'grund', weight: 4 },
                { text: 'Komplexe Textaufgaben', category: 'erweitert', weight: 5 },
                { text: 'Logarithmen', category: 'erweitert', weight: 3 },
                { text: 'Geometrie Grundlagen', category: 'grund', weight: 2 }
            ],
            'Deutsch': [
                { text: 'Rechtschreibung', category: 'grund', weight: 4 },
                { text: 'Grammatik Anwendung', category: 'grund', weight: 3 },
                { text: 'Aufsatz schreiben', category: 'erweitert', weight: 5 }
            ],
            'Englisch': [
                { text: 'Vokabeln A1', category: 'grund', weight: 3 },
                { text: 'Konversation', category: 'erweitert', weight: 4 }
            ]
        };
    }

    // Creates a deep copy of master goals for a new student
    function cloneMasterGoalsForNewStudent() {
        const clonedSubjects = {};
        for (const subjectName in appState.masterSubjects) {
            clonedSubjects[subjectName] = appState.masterSubjects[subjectName].map(goal => ({
                id: Date.now() + Math.random(), // Ensure unique ID for each goal instance
                text: goal.text,
                category: goal.category,
                weight: goal.weight,
                revisions: [] // Start with no revisions for the new student
            }));
        }
        return clonedSubjects;
    }

    // Saves the current application state to localStorage
    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    }

    // Adds a new student
    function addStudent() {
        const name = newStudentNameInput.value.trim();
        if (name && !Object.values(appState.students).some(s => s.name === name)) {
            const studentId = 'student_' + Date.now();
            appState.students[studentId] = {
                id: studentId,
                name: name,
                subjects: cloneMasterGoalsForNewStudent() // Clone master goals
            };
            appState.activeStudent = studentId; // Set new student as active
            appState.activeSubject = null; // Go to overview for new student
            saveState();
            render();
            newStudentNameInput.value = '';
            addStudentForm.classList.add('hidden');
        }
    }

    // Removes a student after user confirmation
    function removeStudent(studentId) {
        const studentName = appState.students[studentId]?.name;
        const message = `Sind Sie sicher, dass Sie den Schüler "${studentName}" und alle seine Daten löschen möchten?`;
        showConfirmationModal(message, () => {
            delete appState.students[studentId];
            if (appState.activeStudent === studentId) {
                appState.activeStudent = Object.keys(appState.students)[0] || null;
                appState.activeSubject = null;
            }
            saveState();
            render();
        });
    }

    // Adds a new subject to the active student's portfolio
    function addSubject() {
        if (!appState.activeStudent) return;
        const name = newSubjectNameInput.value.trim();
        if (name && !appState.students[appState.activeStudent].subjects[name]) {
            appState.students[appState.activeStudent].subjects[name] = [];
            appState.activeSubject = name;
            saveState();
            render();
            newSubjectNameInput.value = '';
            addSubjectForm.classList.add('hidden');
        }
    }
    
    // Removes a subject from the active student's portfolio after user confirmation
    function removeSubject(subjectName) {
        if (!appState.activeStudent) return;
        const message = `Sind Sie sicher, dass Sie das Fach "${subjectName}" und alle zugehörigen Lernziele für ${appState.students[appState.activeStudent].name} löschen möchten?`;
        showConfirmationModal(message, () => {
            delete appState.students[appState.activeStudent].subjects[subjectName];
            if (appState.activeSubject === subjectName) {
                appState.activeSubject = null; // Go to overview after deleting active subject
            }
            saveState();
            render();
        });
    }

    // Adds a new learning goal to the active student's active subject
    function addGoal(goal) {
        if (!appState.activeStudent || !appState.activeSubject) return;
        appState.students[appState.activeStudent].subjects[appState.activeSubject].push({ 
            id: Date.now(),
            text: goal.text,
            category: goal.category,
            weight: goal.weight,
            revisions: [{ date: goal.date, status: goal.status }] // Initial revision
        });
        saveState();
        render();
    }

    // Updates a specific revision (initial or final) of a goal for the active student
    function updateGoalRevision(goalId, newStatus, newDate, isInitialRevision) {
        if (!appState.activeStudent || !appState.activeSubject) return;
        const goals = appState.students[appState.activeStudent].subjects[appState.activeSubject];
        const goalIndex = goals.findIndex(g => g.id === goalId);

        if (goalIndex !== -1) {
            const goal = goals[goalIndex];

            if (isInitialRevision) {
                goal.revisions[0] = { date: newDate, status: newStatus };
            } else {
                if (goal.revisions.length === 0) { // If no initial revision, add it first
                    goal.revisions.push({ date: newDate, status: newStatus });
                } else if (goal.revisions.length === 1) {
                    goal.revisions.push({ date: newDate, status: newStatus });
                } else {
                    goal.revisions[goal.revisions.length - 1] = { date: newDate, status: newStatus };
                }
            }
            // Ensure revisions are sorted by date
            goal.revisions.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveState();
            render();
        }
    }

    // Removes a learning goal from the active student's active subject
    function removeGoal(goalId) {
        if (!appState.activeStudent || !appState.activeSubject) return;
        const goals = appState.students[appState.activeStudent].subjects[appState.activeSubject];
        appState.students[appState.activeStudent].subjects[appState.activeSubject] = goals.filter(g => g.id !== goalId);
        saveState();
        render();
    }
    
    // --- MODAL DIALOG for confirmations and updates ---
    // Displays a custom confirmation modal instead of native alert/confirm
    function showConfirmationModal(message, onConfirm) {
        // Remove existing modal first to prevent duplicates
        const existingModal = document.getElementById('confirmationModal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
            <div id="confirmationModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <p class="text-slate-800 mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="modalCancelBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition">Abbrechen</button>
                        <button id="modalConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Löschen</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modal = document.getElementById('confirmationModal');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        confirmBtn.onclick = () => {
            onConfirm();
            modal.remove();
        };
        cancelBtn.onclick = () => {
            modal.remove();
        };
    }

    // Displays a modal to update a goal's status
    function showUpdateStatusModal(goalId) {
        // Remove existing modal first to prevent duplicates
        const existingModal = document.getElementById('updateStatusModal');
        if (existingModal) {
            existingModal.remove();
        }

        if (!appState.activeStudent || !appState.activeSubject) return;
        const goal = appState.students[appState.activeStudent].subjects[appState.activeSubject].find(g => g.id === goalId);
        if (!goal) return;

        const initialRevision = goal.revisions[0];
        const finalRevision = goal.revisions.length > 1 ? goal.revisions[goal.revisions.length - 1] : null;

        const modalHTML = `
            <div id="updateStatusModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-xs max-h-[70vh] flex flex-col">
                    <h3 class="text-lg font-semibold mb-3 text-slate-800">Lernziel Status aktualisieren</h3>

                    <!-- Section for Initial Evaluation -->
                    <div class="mb-4 border p-3 rounded-md bg-slate-50"> <!-- Reduced p-4 to p-3 -->
                        <h4 class="font-medium text-slate-700 mb-2 text-sm">Beurteilung vor Korrektur</h4> <!-- Reduced mb-3 to mb-2, added text-sm -->
                        <div class="space-y-1.5"> <!-- Reduced space-y-2 to space-y-1.5 -->
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Status:</label> <!-- Changed text-sm to text-xs -->
                                <select id="initialStatusSelect" class="w-full p-1.5 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"> <!-- Reduced p-2 to p-1.5 -->
                                    <option value="erreicht">Erreicht</option>
                                    <option value="teilweise">Teilweise</option>
                                    <option value="nicht">Nicht erreicht</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Datum:</label> <!-- Changed text-sm to text-xs -->
                                <input type="date" id="initialDateInput" required class="w-full p-1.5 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"> <!-- Reduced p-2 to p-1.5 -->
                            </div>
                            <button id="updateInitialBtn" class="w-full bg-indigo-600 text-white font-bold py-1.5 px-3 rounded-md text-sm hover:bg-indigo-700 transition">Aktualisieren (Vor Korrektur)</button> <!-- Reduced py-2 to py-1.5, px-4 to px-3, added text-sm -->
                        </div>
                    </div>

                    <!-- Section for Final Evaluation -->
                    <div class="mb-4 border p-3 rounded-md bg-slate-50"> <!-- Reduced p-4 to p-3 -->
                        <h4 class="font-medium text-slate-700 mb-2 text-sm">Beurteilung nach Korrektur</h4> <!-- Reduced mb-3 to mb-2, added text-sm -->
                        <div class="space-y-1.5"> <!-- Reduced space-y-2 to space-y-1.5 -->
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Status:</label> <!-- Changed text-sm to text-xs -->
                                <select id="finalStatusSelect" class="w-full p-1.5 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"> <!-- Reduced p-2 to p-1.5 -->
                                    <option value="erreicht">Erreicht</option>
                                    <option value="teilweise">Teilweise</option>
                                    <option value="nicht">Nicht erreicht</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Datum:</label> <!-- Changed text-sm to text-xs -->
                                <input type="date" id="finalDateInput" required class="w-full p-1.5 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"> <!-- Reduced p-2 to p-1.5 -->
                            </div>
                            <button id="updateFinalBtn" class="w-full bg-emerald-600 text-white font-bold py-1.5 px-3 rounded-md text-sm hover:bg-emerald-700 transition">Aktualisieren (Nach Korrektur)</button> <!-- Reduced py-2 to py-1.5, px-4 to px-3, added text-sm -->
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-3">
                        <button type="button" id="modalUpdateCancelBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition">Schliessen</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modal = document.getElementById('updateStatusModal');
        const initialStatusSelect = document.getElementById('initialStatusSelect');
        const initialDateInput = document.getElementById('initialDateInput');
        const updateInitialBtn = document.getElementById('updateInitialBtn');

        const finalStatusSelect = document.getElementById('finalStatusSelect');
        const finalDateInput = document.getElementById('finalDateInput');
        const updateFinalBtn = document.getElementById('updateFinalBtn');
        const modalUpdateCancelBtn = document.getElementById('modalUpdateCancelBtn');

        // Populate initial fields
        if (initialRevision) {
             initialStatusSelect.value = initialRevision.status;
             initialDateInput.value = initialRevision.date;
        } else {
             // If no initial revision, set today's date as default
            initialDateInput.valueAsDate = new Date();
            initialStatusSelect.value = 'nicht'; // Default to 'nicht erreicht' for new goals
        }


        // Populate final fields
        if (finalRevision) {
            finalStatusSelect.value = finalRevision.status;
            finalDateInput.value = finalRevision.date;
        } else {
            // If no final revision, set today's date as default for adding one
            finalDateInput.valueAsDate = new Date();
            finalStatusSelect.value = initialRevision ? initialRevision.status : 'nicht'; // Default to initial or 'nicht'
        }

        updateInitialBtn.onclick = () => {
            updateGoalRevision(goalId, initialStatusSelect.value, initialDateInput.value, true); // true for initial
            modal.remove();
        };

        updateFinalBtn.onclick = () => {
            updateGoalRevision(goalId, finalStatusSelect.value, finalDateInput.value, false); // false for final
            modal.remove();
        };
        
        modalUpdateCancelBtn.onclick = () => {
            modal.remove();
        };
    }

    // --- RENDERING FUNCTIONS ---

    // Renders the sidebar with student and subject navigation
    function renderSidebar() {
        // Render students
        studentNav.innerHTML = '';
        Object.values(appState.students).forEach(student => {
            const isActiveStudent = student.id === appState.activeStudent;
            const container = document.createElement('div');
            container.className = 'flex items-center group';

            const button = document.createElement('button');
            button.className = `flex-1 text-left px-3 py-2 rounded-md transition-colors text-slate-700 ${isActiveStudent ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-slate-100'}`;
            button.textContent = student.name;
            button.onclick = () => {
                appState.activeStudent = student.id;
                appState.activeSubject = null; // Go to overview when changing student
                saveState();
                render();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-100 rounded-md transition-all opacity-0 group-hover:opacity-100';
            deleteBtn.title = `Schüler "${student.name}" löschen`;
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                removeStudent(student.id);
            };

            container.appendChild(button);
            container.appendChild(deleteBtn);
            studentNav.appendChild(container);
        });

        // Render subjects for the active student
        subjectNav.innerHTML = '';
        if (appState.activeStudent && appState.students[appState.activeStudent]) {
            Object.keys(appState.students[appState.activeStudent].subjects).forEach(name => {
                const isActiveSubject = name === appState.activeSubject;
                const container = document.createElement('div');
                container.className = 'flex items-center group';

                const button = document.createElement('button');
                button.className = `flex-1 text-left px-3 py-2 rounded-md transition-colors text-slate-700 ${isActiveSubject ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-slate-100'}`;
                button.textContent = name;
                button.onclick = () => {
                    appState.activeSubject = name;
                    saveState();
                    render();
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-100 rounded-md transition-all opacity-0 group-hover:opacity-100';
                deleteBtn.title = `Fach "${name}" löschen`;
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeSubject(name);
                };

                container.appendChild(button);
                container.appendChild(deleteBtn);
                subjectNav.appendChild(container);
            });
        }
        
        // Update overview button style based on activeSubject state
        if (appState.activeSubject === null) {
            showOverviewBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        } else {
            showOverviewBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        }
    }

    // Renders the main content area, either the subject-specific view or the overview
    function renderMainContent() {
        if (!appState.activeStudent) {
            mainContent.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-sm text-center">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">Bitte einen Schüler auswählen</h2>
                    <p class="text-slate-600">Wählen Sie links einen Schüler aus oder fügen Sie einen neuen hinzu, um sein Portfolio anzuzeigen.</p>
                </div>
            `;
            return;
        }

        if (appState.activeSubject === null) {
            renderOverviewPage();
            return;
        }

        // Subject-specific view HTML structure
        mainContent.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
                <!-- Left Column (Form & List) -->
                <div class="xl:col-span-2 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-4 text-slate-800">Neues Lernziel für ${appState.students[appState.activeStudent].name} in ${appState.activeSubject}</h2>
                        <form id="goalForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Text</label>
                                <input type="text" name="text" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Kategorie</label>
                                    <select name="category" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                        <option value="grund">Grundanforderung</option>
                                        <option value="erweitert">Erweiterte Anforderung</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Beurteilung (Initial)</label>
                                    <select name="status" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                        <option value="erreicht">Erreicht</option>
                                        <option value="teilweise">Teilweise</option>
                                        <option value="nicht">Nicht erreicht</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Gewichtung (1-5)</label>
                                <input type="range" name="weight" min="1" max="5" value="3" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Datum (Initial)</label>
                                <input type="date" name="date" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition">Hinzufügen</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-4 text-slate-800">Lernziele-Liste</h2>
                        <div id="goalList" class="space-y-3 max-h-[45vh] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Goal items will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column (Charts) -->
                <div class="xl:col-span-3 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Lernstand Übersicht nach Gewichtung</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-slate-700">Grundanforderungen</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="text-md font-medium text-center text-slate-600">Vor Korrektur</h5>
                                        <div class="h-48 mx-auto">
                                            <canvas id="pieChartGrundInitial"></canvas>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="text-md font-medium text-center text-slate-600">Nach Korrektur</h5>
                                        <div class="h-48 mx-auto">
                                            <canvas id="pieChartGrundCorrected"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-slate-700">Erweiterte Anforderungen</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="text-md font-medium text-center text-slate-600">Vor Korrektur</h5>
                                        <div class="h-48 mx-auto">
                                            <canvas id="pieChartErweitertInitial"></canvas>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="text-md font-medium text-center text-slate-600">Nach Korrektur</h5>
                                        <div class="h-48 mx-auto">
                                            <canvas id="pieChartErweitertCorrected"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Entwicklung Grundanforderungen (Vor Korrektur)</h3>
                                <canvas id="timelineGrund"></canvas>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Entwicklung Erweiterte Anforderungen (Vor Korrektur)</h3>
                                <canvas id="timelineErweitert"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Bubble-Übersicht</h3>
                        <div class="h-80 mx-auto">
                           <canvas id="bubbleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const goalForm = document.getElementById('goalForm');
        // Set default date to today
        goalForm.querySelector('input[name="date"]').valueAsDate = new Date(); 
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newGoal = {
                text: formData.get('text'),
                category: formData.get('category'),
                status: formData.get('status'), // This will be the initial status
                weight: +formData.get('weight'), // Convert to number
                date: formData.get('date'), // This will be the initial date
            };
            addGoal(newGoal);
            e.target.reset(); // Clear form
            goalForm.querySelector('input[name="date"]').valueAsDate = new Date(); // Reset date
        });

        renderGoalList();
        renderCharts();
    }
    
    // Renders the list of learning goals for the active student's active subject
    function renderGoalList() {
        const goalListContainer = document.getElementById('goalList');
        if (!goalListContainer) return;

        // Get goals for the active student and active subject
        const goals = appState.activeStudent && appState.activeSubject
            ? appState.students[appState.activeStudent].subjects[appState.activeSubject] || []
            : [];

        goalListContainer.innerHTML = '';
        if (goals.length === 0) {
            goalListContainer.innerHTML = `<p class="text-slate-500 text-center py-4">Noch keine Lernziele erfasst.</p>`;
            return;
        }

        // Sort goals by date (of the latest revision) in descending order
        goals.slice().sort((a, b) => {
            const dateA = a.revisions.length > 0 ? new Date(a.revisions[a.revisions.length - 1].date) : new Date(0);
            const dateB = b.revisions.length > 0 ? new Date(b.revisions[b.revisions.length - 1].date) : new Date(0);
            return dateB - dateA;
        }).forEach(goal => {
            // Get the latest revision or an empty object if no revisions
            const latestRevision = goal.revisions.length > 0 ? goal.revisions[goal.revisions.length - 1] : {};
            const statusColor = statusInfo[latestRevision.status]?.color || 'bg-slate-400';
            const statusLabel = statusInfo[latestRevision.status]?.label || 'Nicht beurteilt';
            const categoryText = goal.category === 'grund' ? 'Grundanforderung' : 'Erweiterte Anforderung';
            const formattedDate = latestRevision.date ? new Date(latestRevision.date).toLocaleDateString('de-DE') : 'N/A';

            const el = document.createElement('div');
            el.className = 'p-3.5 border border-slate-200 rounded-lg bg-slate-50';
            
            el.innerHTML = `
                <div class="flex justify-between items-start gap-3">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">${goal.text}</p>
                        <div class="flex items-center gap-4 text-sm text-slate-500 mt-2 flex-wrap">
                            <span class="flex items-center gap-1.5 whitespace-nowrap"><span class="w-3 h-3 rounded-full ${statusColor}"></span>${statusLabel}</span>
                            <span>${categoryText}</span>
                            <span>Gewicht: ${goal.weight}</span>
                            <span>${formattedDate}</span>
                        </div>
                        <!-- Visualisierung der Revisionshistorie -->
                        <div class="flex items-center gap-1.5 mt-2">
                            <span class="text-xs text-slate-500">Historie:</span>
                            ${goal.revisions.map(rev => `<span class="w-2.5 h-2.5 rounded-full ${statusInfo[rev.status]?.color}" title="${statusInfo[rev.status]?.label} am ${new Date(rev.date).toLocaleDateString('de-DE')}"></span>`).join('')}
                            ${goal.revisions.length === 0 ? '<span class="text-xs text-slate-400">Keine Beurteilungen</span>' : ''}
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button class="update-goal-btn flex-shrink-0 text-slate-400 hover:text-indigo-600 transition-colors" title="Status aktualisieren">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="delete-goal-btn flex-shrink-0 text-slate-400 hover:text-red-600 transition-colors" title="Löschen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                        </button>
                    </div>
                </div>
            `;
            el.querySelector('.delete-goal-btn').addEventListener('click', () => removeGoal(goal.id));
            el.querySelector('.update-goal-btn').addEventListener('click', () => showUpdateStatusModal(goal.id)); // Event listener for update
            goalListContainer.appendChild(el);
        });
    }

    // Renders all Chart.js graphs for the active student's active subject
    function renderCharts() {
        if (!appState.activeStudent || !appState.students[appState.activeStudent] || !appState.activeSubject) {
            // No student or subject selected, or data is missing, so destroy charts
            for (const chartKey in charts) {
                if (charts[chartKey]) {
                    charts[chartKey].destroy();
                    charts[chartKey] = null;
                }
            }
            return;
        }

        const goals = appState.students[appState.activeStudent].subjects[appState.activeSubject] || [];
        const months = ['Aug', 'Sep', 'Okt', 'Nov', 'Dez', 'Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul'];

        // Destroy existing charts to prevent memory leaks and rendering issues
        for (const chartKey in charts) {
            if (charts[chartKey]) {
                charts[chartKey].destroy();
                charts[chartKey] = null;
            }
        }

        // --- Pie Charts (now four: Grund-Initial, Grund-Corrected, Erweitert-Initial, Erweitert-Corrected) ---
        const pieChartConfigs = [
            { id: 'pieChartGrundInitial', type: 'grund', revisionSource: 'initial', chartKey: 'weightedPieChartGrundInitial', opacityKey: 'pieColorOpaque' },
            { id: 'pieChartGrundCorrected', type: 'grund', revisionSource: 'latest', chartKey: 'weightedPieChartGrundCorrected', opacityKey: 'pieColorTransparent' },
            { id: 'pieChartErweitertInitial', type: 'erweitert', revisionSource: 'initial', chartKey: 'weightedPieChartErweitertInitial', opacityKey: 'pieColorOpaque' },
            { id: 'pieChartErweitertCorrected', type: 'erweitert', revisionSource: 'latest', chartKey: 'weightedPieChartErweitertCorrected', opacityKey: 'pieColorTransparent' },
        ];

        pieChartConfigs.forEach(config => {
            const ctx = document.getElementById(config.id)?.getContext('2d');
            if (!ctx) return;

            const filteredGoals = goals.filter(g => g.category === config.type);
            const statusWeightedSums = { erreicht: 0, teilweise: 0, nicht: 0 };

            filteredGoals.forEach(goal => {
                let relevantRevision;
                if (config.revisionSource === 'initial') {
                    relevantRevision = goal.revisions.length > 0 ? goal.revisions[0] : null;
                } else if (config.revisionSource === 'latest') {
                    if (goal.revisions.length > 1) {
                         relevantRevision = goal.revisions[goal.revisions.length - 1];
                    } else {
                        return; // Skip this goal if it's for 'latest' but only has initial revision
                    }
                } else {
                    return;
                }

                if (relevantRevision && statusWeightedSums[relevantRevision.status] !== undefined) {
                    statusWeightedSums[relevantRevision.status] += goal.weight;
                }
            });

            const pieData = {
                labels: Object.values(statusInfo).map(s => s.label),
                datasets: [{
                    data: Object.keys(statusInfo).map(status => statusWeightedSums[status]),
                    backgroundColor: Object.values(statusInfo).map(s => s[config.opacityKey]),
                    hoverOffset: 4
                }]
            };

            const pieConfig = {
                type: 'pie',
                data: pieData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return `${label}: ${value.toFixed(1)} gew. Pkt. (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };
            charts[config.chartKey] = new Chart(ctx, pieConfig);
        });

        // --- Timeline charts with percentages ---
        ['grund', 'erweitert'].forEach(type => {
            const canvasId = type === 'grund' ? 'timelineGrund' : 'timelineErweitert';
            const chartInstanceKey = type === 'grund' ? 'timelineGrund' : 'timelineErweitert';
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;

            const monthlyWeightedSums = Array(12).fill(0).map(() => ({ erreicht: 0, teilweise: 0, nicht: 0 }));
            
            goals.filter(g => g.category === type).forEach(goal => {
                if (goal.revisions.length > 0) {
                    const initialRevision = goal.revisions[0];
                    const monthIndex = new Date(initialRevision.date).getMonth();
                    const schoolYearMonthIndex = (monthIndex - 7 + 12) % 12;
                    
                    if(monthlyWeightedSums[schoolYearMonthIndex]) { 
                        monthlyWeightedSums[schoolYearMonthIndex][initialRevision.status] += goal.weight;
                    }
                }
            });
            
            const monthlyPercentages = monthlyWeightedSums.map(monthData => {
                const totalWeight = monthData.erreicht + monthData.teilweise + monthData.nicht;
                if (totalWeight === 0) {
                    return { erreicht: 0, teilweise: 0, nicht: 0 };
                }
                return {
                    erreicht: (monthData.erreicht / totalWeight) * 100,
                    teilweise: (monthData.teilweise / totalWeight) * 100,
                    nicht: (monthData.nicht / totalWeight) * 100
                };
            });

            const datasets = Object.keys(statusInfo).map(status => ({
                label: statusInfo[status].label,
                data: monthlyPercentages.map(m => m[status]),
                fill: true,
                backgroundColor: statusInfo[status].chartBg,
                borderColor: statusInfo[status].chartBorder,
                borderWidth: 2,
                tension: 0.3,
            }));

            const config = {
                type: 'line',
                data: { labels: months, datasets },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: { 
                        x: { stacked: true }, 
                        y: { 
                            stacked: true, 
                            min: 0, max: 100,
                            title: { display: true, text: 'Prozentualer Anteil (gewichtet)' },
                            ticks: { callback: value => value + '%' }
                        } 
                    },
                    plugins: { 
                        legend: { position: 'bottom' }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
                            } 
                        } 
                    },
                    interaction: { mode: 'index', intersect: false },
                }
            };
            charts[chartInstanceKey] = new Chart(ctx, config);
        });

        // --- Bubble chart ---
        const ctxB = document.getElementById('bubbleChart')?.getContext('2d');
        if (!ctxB) return;
        
        const aggregatedBubbleDataForVisuals = {
            'grund_initial': { 'erreicht': {weight: 0, count: 0}, 'teilweise': {weight: 0, count: 0}, 'nicht': {weight: 0, count: 0} },
            'grund_corrected': { 'erreicht': {weight: 0, count: 0}, 'teilweise': {weight: 0, count: 0}, 'nicht': {weight: 0, count: 0} },
            'erweitert_initial': { 'erreicht': {weight: 0, count: 0}, 'teilweise': {weight: 0, count: 0}, 'nicht': {weight: 0, count: 0} },
            'erweitert_corrected': { 'erreicht': {weight: 0, count: 0}, 'teilweise': {weight: 0, count: 0}, 'nicht': {weight: 0, count: 0} }
        };

        goals.forEach(goal => {
            const initialRevision = goal.revisions.length > 0 ? goal.revisions[0] : null;
            const latestRevision = goal.revisions.length > 0 ? goal.revisions[goal.revisions.length - 1] : null;
            const isCorrected = goal.revisions.length > 1;

            if (initialRevision) {
                const initialBucketKey = `${goal.category}_initial`;
                aggregatedBubbleDataForVisuals[initialBucketKey][initialRevision.status].weight += goal.weight;
                aggregatedBubbleDataForVisuals[initialBucketKey][initialRevision.status].count += 1;
            }

            if (isCorrected && latestRevision) {
                const correctedBucketKey = `${goal.category}_corrected`;
                aggregatedBubbleDataForVisuals[correctedBucketKey][latestRevision.status].weight += goal.weight;
                aggregatedBubbleDataForVisuals[correctedBucketKey][latestRevision.status].count += 1;
            }
        });

        const bubbleChartDatasets = [];
        const xPositions = { 'grund_initial': 0, 'grund_corrected': 1, 'erweitert_initial': 2, 'erweitert_corrected': 3 };
        const yPositions = { 'nicht': 0, 'teilweise': 1, 'erreicht': 2 };
        const jitterAmount = 0.2;

        function createBubbleDataset(categoryType, pointStyle, opacityKey, legendLabelBase) {
            const dataPoints = [];
            const backgroundColors = [];
            const borderColors = [];

            Object.keys(aggregatedBubbleDataForVisuals[categoryType]).forEach(status => {
                const sumWeight = aggregatedBubbleDataForVisuals[categoryType][status].weight;
                const count = aggregatedBubbleDataForVisuals[categoryType][status].count;
                if (sumWeight > 0) {
                    dataPoints.push({
                        x: xPositions[categoryType] + (Math.random() - 0.5) * jitterAmount,
                        y: yPositions[status] + (Math.random() - 0.5) * jitterAmount,
                        r: Math.sqrt(sumWeight) * 8 + 4,
                        label: `${legendLabelBase.trim()} - ${statusInfo[status].label}: ${sumWeight.toFixed(1)} gew. Pkt. (${count} Ziele)`
                    });
                    backgroundColors.push(statusInfo[status][opacityKey]);
                    borderColors.push(statusInfo[status].bubbleBorderColor);
                }
            });

            if (dataPoints.length > 0) {
                bubbleChartDatasets.push({
                    label: legendLabelBase,
                    pointStyle: pointStyle,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 0,
                    data: dataPoints
                });
            }
        }

        createBubbleDataset('grund_initial', 'circle', 'chartBgOpaque', 'GA vor Korr.');
        createBubbleDataset('grund_corrected', 'circle', 'chartBgTransparent', 'GA nach Korr.');
        createBubbleDataset('erweitert_initial', 'rect', 'chartBgOpaque', 'EA vor Korr.');
        createBubbleDataset('erweitert_corrected', 'rect', 'chartBgTransparent', 'EA nach Korr.');


        const configB = {
            type: 'bubble',
            data: { datasets: bubbleChartDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        min: -0.5,
                        max: 3.5,
                        ticks: {
                            callback: function(value, index, values) {
                                if (value === 0) return 'GA vor Korr.';
                                if (value === 1) return 'GA nach Korr.';
                                if (value === 2) return 'EA vor Korr.';
                                if (value === 3) return 'EA nach Korr.';
                                return '';
                            },
                            display: true,
                            stepSize: 1
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        min: -0.5,
                        max: 2.5,
                        ticks: {
                            callback: function(value, index, values) {
                                if (value === 0) return 'Nicht erreicht';
                                if (value === 1) return 'Teilweise';
                                if (value === 2) return 'Erreicht';
                                return '';
                            },
                            display: true,
                            stepSize: 1
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.datasets.length) {
                                    return data.datasets.map((dataset, i) => {
                                        return {
                                            text: dataset.label,
                                            fillStyle: dataset.backgroundColor[0],
                                            strokeStyle: dataset.borderColor[0],
                                            pointStyle: dataset.pointStyle,
                                            hidden: !chart.isDatasetVisible(i),
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw.label;
                            }
                        }
                    }
                }
            }
        };
        charts.bubbleChart = new Chart(ctxB, configB);
    }
    
    // Renders the overview page displaying a summary of the active student's progress
    function renderOverviewPage() {
        if (!appState.activeStudent) {
            mainContent.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-sm text-center">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">Bitte einen Schüler auswählen</h2>
                    <p class="text-slate-600">Wählen Sie links einen Schüler aus oder fügen Sie einen neuen hinzu, um sein Portfolio anzuzeigen.</p>
                </div>
            `;
            return;
        }

        const student = appState.students[appState.activeStudent];
        const subjects = student.subjects;

        mainContent.innerHTML = `
            <div class="p-8 bg-white rounded-xl shadow-sm">
                <h2 class="text-3xl font-bold mb-6 text-slate-800">Übersicht Lernstand für ${student.name}</h2>
                <div id="subjectOverviewGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Subject overview cards will be injected here -->
                </div>
                <div class="flex justify-start mt-6">
                     <button id="addSubjectInOverviewBtn" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                         Neues Fach hinzufügen
                     </button>
                </div>
                <div id="addSubjectFormInOverview" class="hidden mt-4 p-3 bg-slate-50 rounded-lg transition-all max-w-sm">
                    <input type="text" id="newSubjectNameInOverview" placeholder="Name des Fachs..." class="w-full px-2 py-1.5 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <div class="flex gap-2 mt-2">
                        <button id="addSubjectBtnInOverview" class="flex-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-md hover:bg-indigo-700 transition-colors">Hinzufügen</button>
                        <button id="cancelAddSubjectBtnInOverview" class="flex-1 px-3 py-1.5 bg-slate-200 text-slate-700 text-sm rounded-md hover:bg-slate-300 transition-colors">Abbrechen</button>
                    </div>
                </div>
            </div>
        `;

        const overviewGrid = document.getElementById('subjectOverviewGrid');
        if (!overviewGrid) return;

        if (Object.keys(subjects).length === 0) {
            overviewGrid.innerHTML = `<p class="text-slate-500 text-center col-span-full py-10">Noch keine Fächer für ${student.name} erfasst.</p>`;
        }

        Object.keys(subjects).forEach(subjectName => {
            const goals = subjects[subjectName];

            const grundGoals = goals.filter(g => g.category === 'grund');
            const totalWeightedGrund = grundGoals.reduce((sum, g) => sum + g.weight, 0);
            const achievedWeightedGrund = grundGoals.filter(g => g.revisions.length > 0 && g.revisions[g.revisions.length - 1].status === 'erreicht').reduce((sum, g) => sum + g.weight, 0);
            const percentageGrund = totalWeightedGrund > 0 ? ((achievedWeightedGrund / totalWeightedGrund) * 100).toFixed(0) : 0;

            const erweitertGoals = goals.filter(g => g.category === 'erweitert');
            const totalWeightedErweitert = erweitertGoals.reduce((sum, g) => sum + g.weight, 0);
            const achievedWeightedErweitert = erweitertGoals.filter(g => g.revisions.length > 0 && g.revisions[g.revisions.length - 1].status === 'erreicht').reduce((sum, g) => sum + g.weight, 0);
            const percentageErweitert = totalWeightedErweitert > 0 ? ((achievedWeightedErweitert / totalWeightedErweitert) * 100).toFixed(0) : 0;
            
            const progressColorGrund = percentageGrund >= 75 ? 'bg-emerald-500' : (percentageGrund >= 40 ? 'bg-amber-500' : 'bg-red-500');
            const progressColorErweitert = percentageErweitert >= 75 ? 'bg-emerald-500' : (percentageErweitert >= 40 ? 'bg-amber-500' : 'bg-red-500');

            const card = document.createElement('div');
            card.className = `bg-slate-50 p-6 rounded-lg shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-shadow`;
            card.onclick = () => {
                appState.activeSubject = subjectName;
                saveState();
                render();
            };
            card.innerHTML = `
                <h3 class="text-xl font-bold text-slate-800 mb-3">${subjectName}</h3>
                
                <div class="mb-3">
                    <p class="text-sm text-slate-600 mb-1">Grundanforderungen:</p>
                    <div class="flex items-center gap-3">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full ${progressColorGrund}" style="width: ${percentageGrund}%"></div>
                        </div>
                        <span class="text-slate-600 font-semibold text-sm">${percentageGrund}%</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">${achievedWeightedGrund.toFixed(1)} von ${totalWeightedGrund.toFixed(1)} gewichteten Punkten</p>
                </div>

                <div>
                    <p class="text-sm text-slate-600 mb-1">Erweiterte Anforderungen:</p>
                    <div class="flex items-center gap-3">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full ${progressColorErweitert}" style="width: ${percentageErweitert}%"></div>
                        </div>
                        <span class="text-slate-600 font-semibold text-sm">${percentageErweitert}%</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">${achievedWeightedErweitert.toFixed(1)} von ${totalWeightedErweitert.toFixed(1)} gewichteten Punkten</p>
                </div>
            `;
            overviewGrid.appendChild(card);
        });

        // Event listeners for Add Subject from overview page
        const addSubjectInOverviewBtn = document.getElementById('addSubjectInOverviewBtn');
        const addSubjectFormInOverview = document.getElementById('addSubjectFormInOverview');
        const newSubjectNameInOverview = document.getElementById('newSubjectNameInOverview');
        const addSubjectBtnInOverview = document.getElementById('addSubjectBtnInOverview');
        const cancelAddSubjectBtnInOverview = document.getElementById('cancelAddSubjectBtnInOverview');

        if (addSubjectInOverviewBtn) {
            addSubjectInOverviewBtn.addEventListener('click', () => {
                addSubjectFormInOverview.classList.remove('hidden');
                newSubjectNameInOverview.focus();
            });
        }
        if (cancelAddSubjectBtnInOverview) {
            cancelAddSubjectBtnInOverview.addEventListener('click', () => {
                addSubjectFormInOverview.classList.add('hidden');
                newSubjectNameInOverview.value = '';
            });
        }
        if (addSubjectBtnInOverview) {
            addSubjectBtnInOverview.addEventListener('click', () => {
                const name = newSubjectNameInOverview.value.trim();
                if (name && appState.activeStudent && !appState.students[appState.activeStudent].subjects[name]) {
                    appState.students[appState.activeStudent].subjects[name] = []; // Add empty subject
                    saveState();
                    render();
                    newSubjectNameInOverview.value = '';
                    addSubjectFormInOverview.classList.add('hidden');
                }
            });
        }
        if (newSubjectNameInOverview) {
            newSubjectNameInOverview.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const name = newSubjectNameInOverview.value.trim();
                    if (name && appState.activeStudent && !appState.students[appState.activeStudent].subjects[name]) {
                        appState.students[appState.activeStudent].subjects[name] = [];
                        saveState();
                        render();
                        newSubjectNameInOverview.value = '';
                        addSubjectFormInOverview.classList.add('hidden');
                    }
                }
            });
        }
    }

    // --- MASTER RENDER & EVENT LISTENERS ---
    // Main render function that orchestrates UI updates
    function render() {
        renderSidebar();
        renderMainContent();
    }

    // Event listeners for student management
    showAddStudentBtn.addEventListener('click', () => {
        addStudentForm.classList.remove('hidden');
        newStudentNameInput.focus();
    });
    cancelAddStudentBtn.addEventListener('click', () => {
        addStudentForm.classList.add('hidden');
        newStudentNameInput.value = '';
    });
    addStudentBtn.addEventListener('click', addStudent);
    newStudentNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addStudent();
    });

    // Event listener for the "Übersicht" button
    showOverviewBtn.addEventListener('click', () => {
        appState.activeSubject = null; // Set active subject to null to show overview for current student
        saveState();
        render();
    });

    // --- INITIALIZATION ---
    loadState(); // Load saved data
    render(); // Initial render of the UI
});
</script>

</body>
</html>
